<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Жаркое из говядины - SmartCook</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        .recipe-header {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .recipe-back {
            position: absolute;
            top: var(--spacing-md);
            left: var(--spacing-md);
            z-index: 10;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .recipe-favorite {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            z-index: 10;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .recipe-favorite.active {
            background: var(--color-primary);
        }

        .recipe-favorite svg {
            width: 20px;
            height: 20px;
            fill: var(--color-text-secondary);
        }

        .recipe-favorite.active svg {
            fill: white;
        }

        .recipe-main-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            background: var(--color-bg-tertiary);
        }

        .recipe-thumbnails {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .recipe-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color var(--transition-fast);
        }

        .recipe-thumbnail:hover,
        .recipe-thumbnail.active {
            border-color: var(--color-primary);
        }

        .recipe-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin: var(--spacing-lg) 0 var(--spacing-md);
        }

        .recipe-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .recipe-section {
            background: var(--color-bg);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
        }

        .recipe-section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
        }

        .ingredients-list {
            list-style: none;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--color-border-light);
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .ingredient-name {
            flex: 1;
            font-size: var(--font-size-base);
        }

        .recipe-step {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .recipe-step-number {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
        }

        .recipe-step-content {
            flex: 1;
        }

        .recipe-step-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-sm);
        }

        .recipe-step-description {
            color: var(--color-text-secondary);
            line-height: 1.6;
            margin-bottom: var(--spacing-sm);
        }

        .recipe-step-image {
            width: 100%;
            max-width: 300px;
            border-radius: var(--radius-md);
            margin-top: var(--spacing-sm);
        }

        .rating-section {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .rating-stars-display {
            display: flex;
            gap: 2px;
        }

        .rating-value {
            font-weight: var(--font-weight-semibold);
            margin-left: var(--spacing-sm);
        }

        .rating-reviews {
            color: var(--color-primary);
            text-decoration: underline;
            cursor: pointer;
        }

        .comment-item {
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--color-border-light);
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .comment-username {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .comment-date {
            font-size: var(--font-size-xs);
            color: var(--color-text-light);
        }

        .comment-text {
            color: var(--color-text);
            line-height: 1.6;
        }

        .comment-delete {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        @media (min-width: 1024px) {
            .recipe-detail-grid {
                display: grid;
                grid-template-columns: 1fr 400px;
                gap: var(--spacing-xl);
            }

            .recipe-main-image {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="page-content">
        <div class="container">
            <div id="recipe-content"></div>

            <div class="recipe-section" id="comments-section">
                <h2 class="recipe-section-title">Комментарии</h2>
                <div id="comments-list"></div>
                <div id="comment-form" style="display: none;">
                    <div class="form-group">
                        <textarea id="comment-text" placeholder="Оставьте комментарий..." rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="submitComment()">Отправить</button>
                </div>
                <p id="login-prompt" style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">
                    Войдите, чтобы оставить комментарий
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { api } from './js/api.js';
        import { renderStep, renderComment } from './js/components.js';
        import { formatTime, formatRating, formatReviews, formatServings, showToast, showLoading } from './js/utils.js';

        const recipeId = new URLSearchParams(window.location.search).get('id');
        let isFavorite = false;
        let currentUser = null;
        let userRating = 0;

        async function init() {
            if (!recipeId) {
                document.getElementById('recipe-content').innerHTML = 
                    '<div class="alert alert-error">Рецепт не найден</div>';
                return;
            }

            // Проверка авторизации
            const token = api.getToken();
            if (token) {
                try {
                    currentUser = await api.getProfile();
                    await loadUserRating();
                } catch (e) {
                    console.error('Failed to load user data:', e);
                }
            }

            await loadRecipe();
        }

        async function loadRecipe() {
            showLoading(document.getElementById('recipe-content'));

            try {
                const recipe = await api.getRecipe(recipeId);
                displayRecipe(recipe);

                // Добавляем в историю, если авторизован
                if (api.getToken()) {
                    try {
                        await api.addToHistory(recipeId);
                    } catch (e) {
                        console.error('Failed to add to history:', e);
                    }
                }

                await loadComments();
                await checkFavorite();
            } catch (error) {
                document.getElementById('recipe-content').innerHTML = 
                    `<div class="alert alert-error">${error.message || 'Не удалось загрузить рецепт'}</div>`;
            }
        }

        function displayRecipe(recipe) {
            const container = document.getElementById('recipe-content');
            const mainImage = recipe.image_url || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23F3F4F6" width="400" height="300"/%3E%3C/svg%3E';
            
            container.innerHTML = `
                <div class="recipe-header">
                    <button class="recipe-back" onclick="window.history.back()">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                    </button>
                    <button class="recipe-favorite ${isFavorite ? 'active' : ''}" onclick="toggleFavorite()" id="favorite-btn" style="${api.getToken() ? '' : 'display: none;'}">
                        <svg viewBox="0 0 24 24">
                            <path d="${isFavorite ? 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z' : 'M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z'}"/>
                        </svg>
                    </button>
                    <img src="${mainImage}" alt="${recipe.title}" class="recipe-main-image" id="main-image">
                    ${recipe.steps && recipe.steps.some(s => s.image_url) ? `
                        <div class="recipe-thumbnails">
                            ${recipe.steps.filter(s => s.image_url).slice(0, 3).map((step, idx) => `
                                <img src="${step.image_url}" alt="Шаг ${step.number}" class="recipe-thumbnail ${idx === 0 ? 'active' : ''}" 
                                     onclick="changeMainImage('${step.image_url}')">
                            `).join('')}
                        </div>
                    ` : ''}
                </div>

                <h1 class="recipe-title">${recipe.title}</h1>

                <div class="recipe-meta">
                    ${recipe.avg_rating ? `
                        <div class="rating-section">
                            <div class="rating-stars-display">
                                ${Array(5).fill(0).map((_, i) => 
                                    `<span style="color: ${i < Math.floor(recipe.avg_rating) ? '#F59E0B' : '#E5E7EB'}">⭐</span>`
                                ).join('')}
                            </div>
                            <span class="rating-value">${formatRating(recipe.avg_rating)}</span>
                            ${recipe.comments_count ? `<span class="rating-reviews">${formatReviews(recipe.comments_count)}</span>` : ''}
                        </div>
                    ` : ''}
                    <span>⏱ ${formatTime(recipe.cooking_time)}</span>
                    <span>${formatServings(5)}</span>
                    <span>${recipe.difficulty}</span>
                </div>

                ${recipe.description ? `
                    <div class="recipe-section">
                        <p style="line-height: 1.6; color: var(--color-text-secondary);">${recipe.description}</p>
                    </div>
                ` : ''}

                <div class="recipe-section">
                    <h3 class="recipe-section-title">Ингредиенты:</h3>
                    <ul class="ingredients-list">
                        ${recipe.ingredients.map(ing => `
                            <li class="ingredient-item">
                                <span class="ingredient-name">${ing.name}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                ${recipe.steps && recipe.steps.length > 0 ? `
                    <div class="recipe-section">
                        <h3 class="recipe-section-title">Как готовить?</h3>
                        ${recipe.steps.map(step => renderStep(step, step.number)).join('')}
                    </div>
                ` : ''}

                ${recipe.missing_ingredients && recipe.missing_ingredients.length > 0 ? `
                    <div class="recipe-section">
                        <div class="recipe-card-status missing">
                            ! Нужно докупить: ${recipe.missing_ingredients.map(ing => ing.name).join(', ')}
                        </div>
                    </div>
                ` : ''}

                ${api.getToken() ? `
                    <div class="recipe-section">
                        <h3 class="recipe-section-title">Оцените рецепт</h3>
                        <div class="rating-input">
                            ${[1,2,3,4,5].map(i => `
                                <button onclick="setRating(${i})" id="star-${i}" class="rating-star ${i <= userRating ? 'active' : ''}" style="font-size: 2rem; background: none; border: none; cursor: pointer; color: ${i <= userRating ? '#F59E0B' : '#E5E7EB'}">⭐</button>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Показываем форму комментариев если авторизован
            if (api.getToken()) {
                document.getElementById('comment-form').style.display = 'block';
                document.getElementById('login-prompt').style.display = 'none';
            }
        }

        function changeMainImage(url) {
            document.getElementById('main-image').src = url;
            document.querySelectorAll('.recipe-thumbnail').forEach(thumb => {
                thumb.classList.toggle('active', thumb.src === url);
            });
        }

        async function checkFavorite() {
            if (!api.getToken()) return;
            
            try {
                const favorites = await api.getFavorites();
                isFavorite = favorites.some(r => r.id === parseInt(recipeId));
                updateFavoriteButton();
            } catch (e) {
                console.error('Failed to check favorite:', e);
            }
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('favorite-btn');
            if (!btn) return;
            
            if (isFavorite) {
                btn.classList.add('active');
                btn.querySelector('svg path').setAttribute('d', 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z');
            } else {
                btn.classList.remove('active');
                btn.querySelector('svg path').setAttribute('d', 'M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z');
            }
        }

        async function toggleFavorite() {
            if (!api.getToken()) {
                window.location.href = 'login.html';
                return;
            }

            try {
                if (isFavorite) {
                    await api.removeFavorite(recipeId);
                    isFavorite = false;
                } else {
                    await api.addFavorite(recipeId);
                    isFavorite = true;
                }
                updateFavoriteButton();
                showToast(isFavorite ? 'Добавлено в избранное' : 'Удалено из избранного', 'success');
            } catch (error) {
                showToast('Ошибка обновления избранного', 'error');
            }
        }

        async function loadUserRating() {
            try {
                const marks = await api.getMarks();
                const mark = marks.find(m => m.recipe_id === parseInt(recipeId));
                if (mark) {
                    userRating = mark.value;
                }
            } catch (e) {
                // Не критично
            }
        }

        async function setRating(value) {
            if (!api.getToken()) {
                window.location.href = 'login.html';
                return;
            }

            try {
                await api.upsertMark(recipeId, value);
                userRating = value;
                
                // Обновляем звёзды
                for (let i = 1; i <= 5; i++) {
                    const star = document.getElementById(`star-${i}`);
                    if (star) {
                        star.style.color = i <= value ? '#F59E0B' : '#E5E7EB';
                        star.classList.toggle('active', i <= value);
                    }
                }
                showToast('Оценка сохранена', 'success');
            } catch (error) {
                showToast('Ошибка сохранения оценки', 'error');
            }
        }

        async function loadComments() {
            try {
                const comments = await api.getComments(recipeId);
                displayComments(comments);
            } catch (error) {
                console.error('Failed to load comments:', error);
                document.getElementById('comments-list').innerHTML = '<p>Не удалось загрузить комментарии</p>';
            }
        }

        function displayComments(comments) {
            const container = document.getElementById('comments-list');
            if (!comments || comments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Комментариев пока нет</p>';
                return;
            }

            container.innerHTML = comments.map(comment => {
                const canDelete = currentUser && (currentUser.id === comment.consumer_id || currentUser.role_id === 1);
                return renderComment(comment, {
                    showDelete: canDelete,
                    onDelete: canDelete ? `deleteComment(${comment.id})` : null,
                    currentUserId: currentUser?.id
                });
            }).join('');
        }

        async function deleteComment(commentId) {
            if (!confirm('Удалить комментарий?')) return;

            try {
                await api.deleteComment(commentId);
                showToast('Комментарий удален', 'success');
                loadComments();
            } catch (error) {
                showToast('Ошибка удаления комментария', 'error');
            }
        }

        async function submitComment() {
            if (!api.getToken()) {
                window.location.href = 'login.html';
                return;
            }

            const text = document.getElementById('comment-text').value.trim();
            if (!text) {
                showToast('Введите текст комментария', 'info');
                return;
            }

            try {
                await api.createComment(recipeId, text);
                document.getElementById('comment-text').value = '';
                showToast('Комментарий добавлен', 'success');
                loadComments();
            } catch (error) {
                showToast(error.message || 'Ошибка добавления комментария', 'error');
            }
        }

        window.toggleFavorite = toggleFavorite;
        window.setRating = setRating;
        window.submitComment = submitComment;
        window.deleteComment = deleteComment;
        window.changeMainImage = changeMainImage;

        init();
    </script>

    <script type="module">
        import { renderBottomNav } from './js/components.js';
        document.body.insertAdjacentHTML('beforeend', renderBottomNav(''));
    </script>
</body>
</html>
