<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–†–µ—Ü–µ–ø—Ç—ã –¥–ª—è –≤–∞—Å - SmartCook</title>
    <link rel="icon" href="/static/brand/favicon.svg" type="image/svg+xml">

    <link rel="stylesheet" href="css/common.css">
    <style>
        .page-header {
            padding: var(--spacing-lg) 0;
            background: var(--color-bg);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-sm);
        }

        .sort-filter {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .sort-filter select {
            border: none;
            background: transparent;
            color: var(--color-primary);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        .section-header {
            margin-bottom: var(--spacing-md);
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-xs);
        }

        .section-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <script type="module">
        import { isAuthenticated } from './js/auth.js';

        (async () => {
            const authenticated = await isAuthenticated();
            window.location.replace(authenticated ? 'categories.html' : 'login.html');
        })();
    </script>

    <div class="app-shell">
        <main class="app-main">
            <div class="page-content">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">–†–µ—Ü–µ–ø—Ç—ã –¥–ª—è –≤–∞—Å</h1>
                        <div class="sort-filter">
                            <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
                            <select id="sort-select" onchange="changeSort()">
                                <option value="match">–ü–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é</option>
                                <option value="popular">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                                <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
                                <option value="time">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</option>
                            </select>
                        </div>
                    </div>

                    <section class="section">
                        <div class="section-header">
                            <h2 class="section-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
                            <p class="section-subtitle">–ü–æ–¥–æ–±—Ä–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å</p>
                        </div>
                        <div id="recommendations" class="recipe-grid"></div>
                    </section>

                    <section class="section">
                        <div class="section-header">
                            <h2 class="section-title">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã</h2>
                            <p class="section-subtitle">–õ—é–±–∏–º—ã–µ –≤—Å–µ–º–∏</p>
                        </div>
                        <div id="popular" class="recipe-grid"></div>
                    </section>
                </div>
            </div>
        </main>
        <div id="bottom-nav"></div>
    </div>

    <script type="module">
        import { api } from './js/api.js';
        import { renderRecipeCard } from './js/components.js';
        import { applyImageFallbacks } from './js/image.js';
        import { showLoading, showEmptyState, sortRecipes } from './js/utils.js';

        let currentSort = 'match';
        let favorites = new Set();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        async function init() {
            const token = api.getToken();
            if (token) {
                try {
                    await loadFavorites();
                } catch (e) {
                    console.error('Failed to load favorites:', e);
                }
            }
            await loadRecommendations();
            await loadPopular();
        }

        async function loadFavorites() {
            try {
                const favs = await api.getFavorites();
                favorites = new Set(favs.map(r => r.id));
            } catch (e) {
                // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
            }
        }

        async function loadRecommendations() {
            const container = document.getElementById('recommendations');
            showLoading(container);

            try {
                const token = api.getToken();
                if (token) {
                    const recipes = await api.getRecommendations();
                    displayRecipes(recipes, container, 'recommendations');
                } else {
                    showEmptyState(container, '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '');
                }
            } catch (e) {
                console.error('Failed to load recommendations:', e);
                showEmptyState(container, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É');
            }
        }

        async function loadPopular() {
            const container = document.getElementById('popular');
            showLoading(container);

            try {
                const recipes = await api.searchRecipes({ sort: currentSort });
                const sorted = sortRecipes(recipes, currentSort).slice(0, 6);
                displayRecipes(sorted, container, 'popular');
            } catch (e) {
                console.error('Failed to load popular:', e);
                showEmptyState(container, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É');
            }
        }

        function displayRecipes(recipes, container, sectionId) {
            if (!recipes || recipes.length === 0) {
                showEmptyState(container, '–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞', 'üì≠', 'empty-state--recipes');
                return;
            }

            container.innerHTML = recipes.map(recipe => {
                recipe.is_favorite = favorites.has(recipe.id);
                return renderRecipeCard(recipe, {
                    showFavorite: true,
                    showStatus: true,
                    onClick: `window.location.href='recipe.html?id=${recipe.id}'`,
                    favoriteCallback: `toggleFavorite(${recipe.id}, event)`
                });
            }).join('');
            applyImageFallbacks(container);
        }

        async function toggleFavorite(recipeId, event) {
            event.stopPropagation();
            const card = event.target.closest('.recipe-card');
            const favoriteBtn = card.querySelector('.recipe-card-favorite');
            
            try {
                if (favorites.has(recipeId)) {
                    await api.removeFavorite(recipeId);
                    favorites.delete(recipeId);
                    favoriteBtn.classList.remove('active');
                    favoriteBtn.querySelector('svg path').setAttribute('d', 'M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z');
                } else {
                    await api.addFavorite(recipeId);
                    favorites.add(recipeId);
                    favoriteBtn.classList.add('active');
                    favoriteBtn.querySelector('svg path').setAttribute('d', 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z');
                }
            } catch (e) {
                console.error('Failed to toggle favorite:', e);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
            }
        }

        function changeSort() {
            currentSort = document.getElementById('sort-select').value;
            loadPopular();
        }

        window.toggleFavorite = toggleFavorite;
        window.changeSort = changeSort;

        init();
    </script>

    <script type="module">
        import { renderBottomNav } from './js/components.js';
        const navContainer = document.getElementById('bottom-nav');
        if (navContainer) {
            navContainer.innerHTML = renderBottomNav('search');
        } else {
            document.body.insertAdjacentHTML('beforeend', renderBottomNav('search'));
        }
    </script>
</body>
</html>
