<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>История - SmartCook</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        .page-header {
            padding: var(--spacing-lg) 0;
            background: var(--color-bg);
            margin-bottom: var(--spacing-md);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-md);
        }

        .search-bar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .search-bar input {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <main class="app-main">
            <div class="page-content">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">История</h1>
                        <div class="search-bar">
                            <input type="text" id="search-input" placeholder="Поиск..." oninput="searchHistory()">
                            <button class="btn btn-icon" onclick="searchHistory()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="history" class="recipe-grid"></div>
                </div>
            </div>
        </main>
        <div id="bottom-nav"></div>
    </div>

    <script type="module">
        import { api } from './js/api.js';
        import { requireAuth } from './js/auth.js';
        import { renderRecipeCard } from './js/components.js';
        import { applyImageFallbacks } from './js/image.js';
        import { showLoading, showEmptyState, debounce } from './js/utils.js';

        if (!requireAuth()) {
            window.location.href = 'login.html';
        }

        let allHistory = [];

        async function loadHistory() {
            showLoading(document.getElementById('history'));

            try {
                const recipes = await api.getHistory();
                allHistory = recipes;
                displayRecipes(recipes);
            } catch (error) {
                showEmptyState(document.getElementById('history'), 'Не удалось загрузить историю', '');
            }
        }

        function displayRecipes(recipes) {
            const container = document.getElementById('history');
            if (!recipes || recipes.length === 0) {
                showEmptyState(container, 'История пуста', 'Просмотренные рецепты будут отображаться здесь');
                return;
            }

            container.innerHTML = recipes.map(recipe => {
                recipe.is_favorite = false; // Не показываем favorite в истории
                return renderRecipeCard(recipe, {
                    showFavorite: false,
                    showStatus: false,
                    onClick: `window.location.href='recipe.html?id=${recipe.id}'`
                });
            }).join('');
            applyImageFallbacks(container);
        }

        const searchDebounced = debounce(function(query) {
            if (!query) {
                displayRecipes(allHistory);
                return;
            }

            const filtered = allHistory.filter(recipe => 
                recipe.title.toLowerCase().includes(query.toLowerCase())
            );
            displayRecipes(filtered);
        }, 300);

        function searchHistory() {
            const query = document.getElementById('search-input').value;
            searchDebounced(query);
        }

        window.searchHistory = searchHistory;

        loadHistory();
    </script>

    <script type="module">
        import { renderBottomNav } from './js/components.js';
        const navContainer = document.getElementById('bottom-nav');
        if (navContainer) {
            navContainer.innerHTML = renderBottomNav('history');
        } else {
            document.body.insertAdjacentHTML('beforeend', renderBottomNav('history'));
        }
    </script>
</body>
</html>
