<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ - SmartCook</title>
    <link rel="icon" href="assets/brand/favicon.svg" type="image/svg+xml">

    <link rel="stylesheet" href="css/common.css">
    <style>
        .page-header {
            padding: var(--spacing-lg) 0;
            background: var(--color-bg);
            margin-bottom: var(--spacing-md);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-md);
        }

        .search-bar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .search-bar input {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <main class="app-main">
            <div class="page-content">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ</h1>
                        <div class="search-bar">
                            <input type="text" id="search-input" placeholder="ÐŸÐ¾Ð¸ÑÐº..." oninput="searchFavorites()">
                            <button class="btn btn-icon" onclick="searchFavorites()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="favorites" class="recipe-grid"></div>
                </div>
            </div>
        </main>
        <div id="bottom-nav"></div>
    </div>

    <script type="module">
        import { api } from './js/api.js';
        import { requireAuth } from './js/auth.js';
        import { renderRecipeCard } from './js/components.js';
        import { applyImageFallbacks } from './js/image.js';
        import { showLoading, showEmptyState, debounce } from './js/utils.js';

        let allFavorites = [];

        async function loadFavorites() {
            showLoading(document.getElementById('favorites'));

            try {
                const recipes = await api.getFavorites();
                allFavorites = recipes;
                displayRecipes(recipes);
            } catch (error) {
                showEmptyState(document.getElementById('favorites'), 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ', '');
            }
        }

        function displayRecipes(recipes) {
            const container = document.getElementById('favorites');
            if (!recipes || recipes.length === 0) {
                container.classList.add('empty-centered');
                showEmptyState(container, 'Ð’ Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ð¿Ð¾ÐºÐ° Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½ÐµÑ‚', 'Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ€ÐµÑ†ÐµÐ¿Ñ‚Ñ‹ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ð»Ð¸ÑÑŒ Ð·Ð´ÐµÑÑŒ', 'ðŸ’œ');
                return;
            }

            container.classList.remove('empty-centered');
            container.innerHTML = recipes.map(recipe => {
                recipe.is_favorite = true; // Ð’ÑÐµ Ð·Ð´ÐµÑÑŒ - Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ
                return renderRecipeCard(recipe, {
                    showFavorite: true,
                    showStatus: true,
                    onClick: `window.location.href='recipe.html?id=${recipe.id}'`,
                    favoriteCallback: `removeFavorite(${recipe.id}, event)`
                });
            }).join('');
            applyImageFallbacks(container);
        }

        async function removeFavorite(recipeId, event) {
            event.stopPropagation();
            
            if (!confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð· Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾?')) return;

            try {
                await api.removeFavorite(recipeId);
                allFavorites = allFavorites.filter(r => r.id !== recipeId);
                displayRecipes(allFavorites);
            } catch (e) {
                console.error('Failed to remove favorite:', e);
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¸Ð· Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾');
            }
        }

        const searchDebounced = debounce(function(query) {
            if (!query) {
                displayRecipes(allFavorites);
                return;
            }

            const filtered = allFavorites.filter(recipe => 
                recipe.title.toLowerCase().includes(query.toLowerCase())
            );
            displayRecipes(filtered);
        }, 300);

        function searchFavorites() {
            const query = document.getElementById('search-input').value;
            searchDebounced(query);
        }

        window.removeFavorite = removeFavorite;
        window.searchFavorites = searchFavorites;

        async function init() {
            if (!(await requireAuth())) {
                return;
            }
            loadFavorites();
        }

        init();
    </script>

    <script type="module">
        import { renderBottomNav } from './js/components.js';
        const navContainer = document.getElementById('bottom-nav');
        if (navContainer) {
            navContainer.innerHTML = renderBottomNav('favorites');
        } else {
            document.body.insertAdjacentHTML('beforeend', renderBottomNav('favorites'));
        }
    </script>
</body>
</html>
