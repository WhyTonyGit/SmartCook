<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Создать рецепт - SmartCook</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        .page-header {
            padding: var(--spacing-lg) 0;
            background: var(--color-bg);
            margin-bottom: var(--spacing-md);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-sm);
        }

        .page-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .search-section {
            background: var(--color-bg);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
        }

        .search-bar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .search-bar input {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }

        .popular-ingredients {
            margin-top: var(--spacing-lg);
        }

        .popular-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-md);
        }

        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-md);
        }

        .ingredient-card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .ingredient-card:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .ingredient-card.selected {
            border-color: var(--color-primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .ingredient-card-image {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-md);
            object-fit: cover;
            margin: 0 auto var(--spacing-sm);
            background: var(--color-bg-tertiary);
        }

        .ingredient-card-name {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .selected-ingredients {
            margin-top: var(--spacing-lg);
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .recipe-section {
            margin-top: var(--spacing-xl);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .section-icon {
            font-size: var(--font-size-xl);
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .ingredient-suggestions {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            max-height: 300px;
            overflow-y: auto;
            margin-top: var(--spacing-sm);
            display: none;
        }

        .ingredient-suggestion {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--color-border-light);
        }

        .ingredient-suggestion:hover {
            background: var(--color-bg-secondary);
        }

        .ingredient-suggestion-image {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--color-bg-tertiary);
        }

        .ingredient-suggestion-name {
            flex: 1;
            font-size: var(--font-size-sm);
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <main class="app-main">
            <div class="page-content">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Создать рецепт</h1>
                        <p class="page-subtitle">Найдите ингредиенты или выберите из предложенного списка</p>
                    </div>

                    <div class="search-section">
                        <div class="search-bar">
                            <input type="text" id="ingredient-search" placeholder="Поиск..." autocomplete="off">
                            <button class="btn btn-icon" onclick="searchIngredients()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                        </div>

                        <div class="ingredient-suggestions" id="suggestions"></div>

                        <div class="popular-ingredients">
                            <h3 class="popular-title">Популярные ингредиенты</h3>
                            <div class="ingredient-grid" id="popular-ingredients"></div>
                        </div>

                        <div class="selected-ingredients">
                            <h3 class="popular-title">Выбранные ингредиенты</h3>
                            <div class="selected-tags" id="selected-tags"></div>
                        </div>

                        <button class="btn btn-primary" onclick="searchRecipes()" style="width: 100%; margin-top: var(--spacing-lg);" id="search-btn">
                            Готово
                        </button>
                    </div>

                    <!-- Рецепты: Готово сейчас -->
                    <div class="recipe-section" id="available-section" style="display: none;">
                        <div class="section-header">
                            <span class="section-icon">✓</span>
                            <h2 class="section-title">Готово сейчас</h2>
                        </div>
                        <div class="recipe-grid" id="available-recipes"></div>
                    </div>

                    <!-- Рецепты: Немного докупить -->
                    <div class="recipe-section" id="missing-section" style="display: none;">
                        <div class="section-header">
                            <span class="section-icon">!</span>
                            <h2 class="section-title">Немного докупить</h2>
                        </div>
                        <div class="recipe-grid" id="missing-recipes"></div>
                    </div>
                </div>
            </div>
        </main>
        <div id="bottom-nav"></div>
    </div>

    <script type="module">
        import { api } from './js/api.js';
        import { renderRecipeCard } from './js/components.js';
        import { applyImageFallbacks, PLACEHOLDER_IMAGE } from './js/image.js';
        import { debounce, showLoading, showEmptyState, showToast, sortRecipes, normalizeText } from './js/utils.js';

        let selectedIngredients = [];
        let allIngredients = [];
        let popularIngredients = [];
        let favorites = new Set();

        // Загрузка популярных ингредиентов
        async function loadPopularIngredients() {
            try {
                const ingredients = await api.getIngredients();
                popularIngredients = ingredients.slice(0, 12); // Первые 12 как популярные
                renderPopularIngredients();
            } catch (e) {
                console.error('Failed to load popular ingredients:', e);
            }
        }

        function renderPopularIngredients() {
            const container = document.getElementById('popular-ingredients');
            container.innerHTML = popularIngredients.map(ing => {
                const imageUrl = ing.image_url || '';
                const isSelected = selectedIngredients.includes(ing.id);
                return `
                    <div class="ingredient-card ${isSelected ? 'selected' : ''}" onclick="toggleIngredient(${ing.id}, '${ing.name.replace(/'/g, "\\'")}')">
                        <img src="${PLACEHOLDER_IMAGE}" data-image-url="${imageUrl}" data-image-name="${ing.name}" data-image-type="ingredient" alt="${ing.name}" class="ingredient-card-image" loading="lazy">
                        <div class="ingredient-card-name">${ing.name}</div>
                    </div>
                `;
            }).join('');
            applyImageFallbacks(container);
        }

        function renderSelectedTags() {
            const container = document.getElementById('selected-tags');
            if (selectedIngredients.length === 0) {
                container.innerHTML = '<span style="color: var(--color-text-light);">Выберите ингредиенты</span>';
                return;
            }

            // Получаем имена выбранных ингредиентов
            const selected = allIngredients.filter(ing => selectedIngredients.includes(ing.id));
            container.innerHTML = selected.map(ing => `
                <span class="tag">
                    ${ing.name}
                    <span class="tag-remove" onclick="removeIngredient(${ing.id})">×</span>
                </span>
            `).join('');
        }

        function toggleIngredient(id, name) {
            const index = selectedIngredients.indexOf(id);
            if (index > -1) {
                selectedIngredients.splice(index, 1);
            } else {
                selectedIngredients.push(id);
            }
            renderSelectedTags();
            renderPopularIngredients();
        }

        function removeIngredient(id) {
            selectedIngredients = selectedIngredients.filter(ingId => ingId !== id);
            renderSelectedTags();
            renderPopularIngredients();
        }

        // Поиск ингредиентов
        const searchDebounced = debounce(async function(query) {
            if (!query || query.length < 2) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }

            try {
                const ingredients = await api.getIngredients(query);
                showSuggestions(ingredients);
            } catch (e) {
                console.error('Failed to search ingredients:', e);
            }
        }, 300);

        document.getElementById('ingredient-search').addEventListener('input', (e) => {
            searchDebounced(e.target.value);
        });

        function showSuggestions(ingredients) {
            const container = document.getElementById('suggestions');
            const filtered = ingredients.filter(ing => !selectedIngredients.includes(ing.id));
            
            if (filtered.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = filtered.map(ing => {
                const imageUrl = ing.image_url || '';
                return `
                    <div class="ingredient-suggestion" onclick="addIngredient(${ing.id}, '${ing.name.replace(/'/g, "\\'")}')">
                        <img src="${PLACEHOLDER_IMAGE}" data-image-url="${imageUrl}" data-image-name="${ing.name}" data-image-type="ingredient" alt="${ing.name}" class="ingredient-suggestion-image" loading="lazy">
                        <span class="ingredient-suggestion-name">${ing.name}</span>
                    </div>
                `;
            }).join('');
            container.style.display = 'block';
            applyImageFallbacks(container);
        }

        function addIngredient(id, name) {
            if (!selectedIngredients.includes(id)) {
                selectedIngredients.push(id);
                renderSelectedTags();
                renderPopularIngredients();
            }
            document.getElementById('ingredient-search').value = '';
            document.getElementById('suggestions').style.display = 'none';
        }

        async function searchRecipes() {
            if (selectedIngredients.length === 0) {
                showToast('Выберите хотя бы один ингредиент', 'info');
                return;
            }

            const searchBtn = document.getElementById('search-btn');
            searchBtn.disabled = true;
            searchBtn.textContent = 'Поиск...';

            try {
                // Получаем имена ингредиентов для поиска
                const ingredients = await api.getIngredients();
                const selected = ingredients.filter(ing => selectedIngredients.includes(ing.id));
                const ingredientNames = selected.map(ing => ing.name).join(',');

                const recipes = await api.searchRecipes({
                    ingredients: ingredientNames,
                    minMatch: 0.3,
                    sort: 'match'
                });
                const sortedRecipes = sortRecipes(recipes, 'match');

                // Разделяем на "готово" и "нужно докупить"
                const available = sortedRecipes.filter(r => r.match_percent >= 1.0 || (!r.missing_ingredients || r.missing_ingredients.length === 0));
                const missing = sortedRecipes.filter(r => r.match_percent < 1.0 && r.missing_ingredients && r.missing_ingredients.length > 0);

                displayRecipes(available, 'available-recipes', available.length > 0);
                displayRecipes(missing, 'missing-recipes', missing.length > 0);

                document.getElementById('available-section').style.display = available.length > 0 ? 'block' : 'none';
                document.getElementById('missing-section').style.display = missing.length > 0 ? 'block' : 'none';

                // Прокрутка к результатам
                if (available.length > 0 || missing.length > 0) {
                    document.getElementById('available-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch (e) {
                console.error('Failed to search recipes:', e);
                showToast('Ошибка поиска рецептов', 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Готово';
            }
        }

        async function loadFavorites() {
            try {
                const token = api.getToken();
                if (token) {
                    const favs = await api.getFavorites();
                    favorites = new Set(favs.map(r => r.id));
                }
            } catch (e) {
                // Не критично
            }
        }

        function displayRecipes(recipes, containerId, showSection) {
            const container = document.getElementById(containerId);
            
            if (!recipes || recipes.length === 0) {
                showEmptyState(container, 'Рецепты не найдены', 'Попробуйте выбрать другие ингредиенты');
                return;
            }

            container.innerHTML = recipes.map(recipe => {
                recipe.is_favorite = favorites.has(recipe.id);
                return renderRecipeCard(recipe, {
                    showFavorite: true,
                    showStatus: true,
                    onClick: `window.location.href='recipe.html?id=${recipe.id}'`,
                    favoriteCallback: `toggleFavorite(${recipe.id}, event)`
                });
            }).join('');
            applyImageFallbacks(container);
        }

        async function toggleFavorite(recipeId, event) {
            event.stopPropagation();
            const card = event.target.closest('.recipe-card');
            const favoriteBtn = card.querySelector('.recipe-card-favorite');
            
            try {
                if (favorites.has(recipeId)) {
                    await api.removeFavorite(recipeId);
                    favorites.delete(recipeId);
                    favoriteBtn.classList.remove('active');
                    favoriteBtn.querySelector('svg path').setAttribute('d', 'M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z');
                } else {
                    await api.addFavorite(recipeId);
                    favorites.add(recipeId);
                    favoriteBtn.classList.add('active');
                    favoriteBtn.querySelector('svg path').setAttribute('d', 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z');
                }
            } catch (e) {
                console.error('Failed to toggle favorite:', e);
                showToast('Не удалось обновить избранное', 'error');
            }
        }

        function searchIngredients() {
            const query = document.getElementById('ingredient-search').value;
            if (query) {
                searchDebounced(query);
            }
        }

        // Загрузка ингредиентов из URL параметров
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const ingredientsParam = params.get('ingredients');
            if (ingredientsParam) {
                const names = ingredientsParam.split(',').map(n => normalizeText(n));
                // Найдем ID ингредиентов по именам
                api.getIngredients().then(ingredients => {
                    allIngredients = ingredients;
                    const found = ingredients.filter(ing => names.includes(normalizeText(ing.name)));
                    selectedIngredients = found.map(ing => ing.id);
                    renderSelectedTags();
                    renderPopularIngredients();
                    if (selectedIngredients.length > 0) {
                        searchRecipes();
                    }
                });
            }
        }

        window.toggleIngredient = toggleIngredient;
        window.removeIngredient = removeIngredient;
        window.addIngredient = addIngredient;
        window.searchRecipes = searchRecipes;
        window.searchIngredients = searchIngredients;
        window.toggleFavorite = toggleFavorite;

        // Инициализация
        async function init() {
            await loadAllIngredients();
            await loadPopularIngredients();
            await loadFavorites();
            loadFromURL();
        }

        async function loadAllIngredients() {
            try {
                allIngredients = await api.getIngredients();
            } catch (e) {
                console.error('Failed to load ingredients:', e);
            }
        }

        init();
    </script>

    <script type="module">
        import { renderBottomNav } from './js/components.js';
        const navContainer = document.getElementById('bottom-nav');
        if (navContainer) {
            navContainer.innerHTML = renderBottomNav('search');
        } else {
            document.body.insertAdjacentHTML('beforeend', renderBottomNav('search'));
        }
    </script>
</body>
</html>
