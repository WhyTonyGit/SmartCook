<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç - Recipe Finder</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ingredient-input {
            position: relative;
        }

        .ingredient-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background: #f5f5f5;
        }

        .ingredient-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .ingredient-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #3498db;
            color: white;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .ingredient-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">üç≥ Recipe Finder</a>
            <ul class="nav-links">
                <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="find-recipe.html">–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</a></li>
                <li><a href="categories.html">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <h1 style="margin-bottom: 2rem;">–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</h1>

        <div class="filters">
            <div class="form-group">
                <label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞)</label>
                <div class="ingredient-input">
                    <input type="text" id="ingredients-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫—É—Ä–∏—Ü–∞, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –ª—É–∫">
                    <div class="ingredient-suggestions" id="suggestions"></div>
                </div>
                <div class="ingredient-tags" id="ingredient-tags"></div>
            </div>

            <div class="filters-grid">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="query" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é">
                </div>
                <div class="form-group">
                    <label>–ú–∞–∫—Å. –≤—Ä–µ–º—è (–º–∏–Ω)</label>
                    <input type="number" id="maxTime" min="0">
                </div>
                <div class="form-group">
                    <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                    <select id="difficulty">
                        <option value="">–õ—é–±–∞—è</option>
                        <option value="easy">–õ–µ–≥–∫–∞—è</option>
                        <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                        <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="categoryId">
                        <option value="">–í—Å–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ú–∏–Ω. —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ</label>
                    <input type="number" id="minMatch" min="0" max="1" step="0.1" value="0">
                </div>
                <div class="form-group">
                    <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select id="sort">
                        <option value="match">–ü–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é</option>
                        <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
                        <option value="time">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</option>
                        <option value="popular">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="searchRecipes()">–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç—ã</button>
        </div>

        <div id="results" class="recipe-grid"></div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let selectedIngredients = [];
        let allIngredients = [];
        let categories = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategories() {
            try {
                categories = await api.getCategories();
                const select = document.getElementById('categoryId');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load categories:', e);
            }
        }

        // –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        let suggestionTimeout;
        document.getElementById('ingredients-input').addEventListener('input', (e) => {
            clearTimeout(suggestionTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }

            suggestionTimeout = setTimeout(async () => {
                try {
                    const ingredients = await api.getIngredients(query);
                    showSuggestions(ingredients);
                } catch (e) {
                    console.error('Failed to load suggestions:', e);
                }
            }, 300);
        });

        function showSuggestions(ingredients) {
            const container = document.getElementById('suggestions');
            if (ingredients.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = ingredients.map(ing => `
                <div class="suggestion-item" onclick="addIngredient(${ing.id}, '${ing.name}')">
                    ${ing.name}
                </div>
            `).join('');
            container.style.display = 'block';
        }

        function addIngredient(id, name) {
            if (!selectedIngredients.find(ing => ing.id === id)) {
                selectedIngredients.push({ id, name });
                updateIngredientTags();
            }
            document.getElementById('ingredients-input').value = '';
            document.getElementById('suggestions').style.display = 'none';
        }

        function removeIngredient(id) {
            selectedIngredients = selectedIngredients.filter(ing => ing.id !== id);
            updateIngredientTags();
        }

        function updateIngredientTags() {
            const container = document.getElementById('ingredient-tags');
            container.innerHTML = selectedIngredients.map(ing => `
                <span class="ingredient-tag">
                    ${ing.name}
                    <button onclick="removeIngredient(${ing.id})">√ó</button>
                </span>
            `).join('');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
        document.getElementById('ingredients-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const value = e.target.value.trim();
                if (value) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                    const found = allIngredients.find(ing => 
                        ing.name.toLowerCase() === value.toLowerCase()
                    );
                    if (found) {
                        addIngredient(found.id, found.name);
                    } else {
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç (–±—É–¥–µ—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
                        if (!selectedIngredients.find(ing => ing.name === value)) {
                            selectedIngredients.push({ id: null, name: value });
                            updateIngredientTags();
                        }
                    }
                    e.target.value = '';
                }
            }
        });

        // –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤
        async function searchRecipes() {
            const params = {
                query: document.getElementById('query').value || undefined,
                ingredients: selectedIngredients.map(ing => ing.name).join(','),
                minMatch: parseFloat(document.getElementById('minMatch').value) || 0,
                maxTime: document.getElementById('maxTime').value || undefined,
                difficulty: document.getElementById('difficulty').value || undefined,
                categoryId: document.getElementById('categoryId').value || undefined,
                sort: document.getElementById('sort').value || 'match'
            };

            try {
                const recipes = await api.searchRecipes(params);
                displayRecipes(recipes);
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    `<div class="alert alert-error">${error.message}</div>`;
            }
        }

        function displayRecipes(recipes) {
            const container = document.getElementById('results');
            if (!recipes || recipes.length === 0) {
                container.innerHTML = '<p class="loading">–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            container.innerHTML = recipes.map(recipe => `
                <div class="recipe-card" onclick="window.location.href='recipe.html?id=${recipe.id}'">
                    ${recipe.image_url ? `<img src="${recipe.image_url}" alt="${recipe.title}">` : '<div style="height:200px;background:#ecf0f1;display:flex;align-items:center;justify-content:center;color:#7f8c8d;">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>'}
                    <div class="recipe-card-content">
                        <h3 class="recipe-card-title">${recipe.title}</h3>
                        <div class="recipe-card-meta">
                            <span>‚è± ${recipe.cooking_time} –º–∏–Ω</span>
                            <span>${recipe.difficulty}</span>
                            ${recipe.avg_rating ? `<span>‚≠ê ${recipe.avg_rating.toFixed(1)}</span>` : ''}
                        </div>
                        ${recipe.match_percent !== null ? `<span class="recipe-card-match">${Math.round(recipe.match_percent * 100)}% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ</span>` : ''}
                        ${recipe.missing_ingredients && recipe.missing_ingredients.length > 0 ? 
                            `<div class="tags" style="margin-top:0.5rem;">
                                <small>–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${recipe.missing_ingredients.map(ing => ing.name).join(', ')}</small>
                            </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        async function init() {
            await loadCategories();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
            try {
                allIngredients = await api.getIngredients();
            } catch (e) {
                console.error('Failed to load ingredients:', e);
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
            const urlParams = new URLSearchParams(window.location.search);
            const ingredientsParam = urlParams.get('ingredients');
            if (ingredientsParam) {
                const names = ingredientsParam.split(',').map(n => n.trim());
                document.getElementById('ingredients-input').value = ingredientsParam;
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
                names.forEach(name => {
                    const found = allIngredients.find(ing => 
                        ing.name.toLowerCase() === name.toLowerCase()
                    );
                    if (found) {
                        addIngredient(found.id, found.name);
                    } else {
                        selectedIngredients.push({ id: null, name });
                    }
                });
                updateIngredientTags();
                searchRecipes();
            }
        }

        init();
    </script>
</body>
</html>

