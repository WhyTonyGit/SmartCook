<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Профиль - SmartCook</title>
    <link rel="icon" href="assets/brand/favicon.svg" type="image/svg+xml">

    <link rel="stylesheet" href="css/common.css">
    <style>
        .profile-header {
            background: radial-gradient(circle at 70% 20%, rgba(255, 255, 255, 0.18), transparent 55%),
                linear-gradient(135deg, #6d28d9 0%, #9333ea 100%);
            padding: var(--spacing-2xl) var(--spacing-lg) var(--spacing-xl);
            text-align: center;
            color: white;
            margin-bottom: var(--spacing-xl);
            position: relative;
            border-radius: var(--radius-xl);
        }

        .profile-avatar {
            width: 96px;
            height: 96px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            margin: 0 auto var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-3xl);
            border: 3px solid white;
            box-shadow: var(--shadow-sm);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-full);
            object-fit: cover;
        }

        .profile-name {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-xs);
        }

        .profile-email {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        .profile-actions {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            display: flex;
            gap: var(--spacing-sm);
        }

        .profile-action-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .profile-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-content {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .profile-section {
            background: var(--color-bg);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .profile-section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-md);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        .stat-card {
            background: var(--color-bg-secondary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.04);
        }

        .stat-card:hover {
            background: var(--color-bg-tertiary);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .forbidden-ingredients {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .forbidden-ingredient {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
        }

        .profile-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            text-decoration: none;
            color: var(--color-text);
            transition: all var(--transition-fast);
        }

        .profile-link:hover {
            background: var(--color-bg-tertiary);
            transform: translateX(4px);
        }

        .profile-link-text {
            font-weight: var(--font-weight-medium);
        }

        .profile-link-arrow {
            color: var(--color-primary);
        }

        .logout-button {
            width: 100%;
            font-weight: var(--font-weight-medium);
        }

        @media (min-width: 768px) {
            .profile-stats {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <main class="app-main">
            <div class="profile-header">
                <div class="profile-actions">
                    <button class="profile-action-btn" onclick="window.location.href='edit-profile.html'" title="Редактировать">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </button>
                    <button class="profile-action-btn" onclick="window.location.href='preferences.html?mode=settings'" title="Настройки">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                        </svg>
                    </button>
                </div>
                <div class="profile-avatar" id="avatar-container">
                    <span id="avatar-text">U</span>
                </div>
                <div class="profile-name" id="profile-name">Имя Фамилия</div>
                <div class="profile-email" id="profile-email">email@service.domain</div>
            </div>

            <div class="profile-content">
                <div class="profile-section">
                    <h2 class="profile-section-title">Исключенные ингредиенты:</h2>
                    <div class="forbidden-ingredients" id="forbidden-ingredients">
                        <span style="color: var(--color-text-secondary);">Загрузка...</span>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="profile-stats">
                        <a href="my-comments.html" class="stat-card">
                            <div class="stat-value" id="comments-count">0</div>
                            <div class="stat-label">Написано отзывов</div>
                        </a>
                        <a href="my-marks.html" class="stat-card">
                            <div class="stat-value" id="marks-count">0</div>
                            <div class="stat-label">Оценено рецептов</div>
                        </a>
                    </div>
                </div>

                <div class="profile-section">
                    <a href="my-comments.html" class="profile-link">
                        <span class="profile-link-text">Мои отзывы</span>
                        <span class="profile-link-arrow">›</span>
                    </a>
                    <a href="my-marks.html" class="profile-link">
                        <span class="profile-link-text">Мои оценки</span>
                        <span class="profile-link-arrow">›</span>
                    </a>
                    <a href="history.html" class="profile-link">
                        <span class="profile-link-text">История</span>
                        <span class="profile-link-arrow">›</span>
                    </a>
                    <a href="favourites.html" class="profile-link">
                        <span class="profile-link-text">Избранное</span>
                        <span class="profile-link-arrow">›</span>
                    </a>
                </div>

                <div class="profile-section">
                    <button class="btn btn-danger logout-button" onclick="logout()">
                        Выйти
                    </button>
                </div>
            </div>
        </main>
        <div id="bottom-nav"></div>
    </div>

    <script type="module">
        import { api } from './js/api.js';
        import { requireAuth } from './js/auth.js';
        import { showToast } from './js/utils.js';
        import { setImageWithFallback, PLACEHOLDER_IMAGE } from './js/image.js';

        async function loadProfile() {
            try {
                const profile = await api.getProfile();
                
                document.getElementById('profile-name').textContent = profile.username || 'Пользователь';
                document.getElementById('profile-email').textContent = profile.email || '';
                
                const avatarContainer = document.getElementById('avatar-container');
                const storageKey = profile.id ? `avatar:user:${profile.id}` : profile.email ? `avatar:email:${profile.email}` : null;
                const storedAvatar = storageKey ? localStorage.getItem(storageKey) : '';
                const avatarUrl = profile.avatar_url || storedAvatar || '';
                if (avatarUrl) {
                    avatarContainer.innerHTML = `<img src="${PLACEHOLDER_IMAGE}" data-image-url="${avatarUrl}" alt="${profile.username}">`;
                    const avatarImg = avatarContainer.querySelector('img');
                    setImageWithFallback(avatarImg, avatarUrl);
                } else {
                    avatarContainer.innerHTML = `<span>${(profile.username || 'U')[0].toUpperCase()}</span>`;
                }

                // Загружаем исключенные ингредиенты
                const forbidden = await api.getForbiddenIngredients();
                const forbiddenContainer = document.getElementById('forbidden-ingredients');
                if (forbidden.length === 0) {
                    forbiddenContainer.innerHTML = '<span style="color: var(--color-text-secondary);">Нет исключенных ингредиентов</span>';
                } else {
                    forbiddenContainer.innerHTML = forbidden.map(ing => `
                        <span class="forbidden-ingredient">${ing.name}</span>
                    `).join('');
                }

                // Загружаем статистику
                try {
                    const comments = await api.getComments ? [] : []; // TODO: получить все комментарии пользователя
                    const marks = await api.getMarks();
                    
                    document.getElementById('comments-count').textContent = comments.length || 0;
                    document.getElementById('marks-count').textContent = marks.length || 0;
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            } catch (error) {
                showToast('Ошибка загрузки профиля', 'error');
            }
        }

        function logout() {
            if (confirm('Выйти из аккаунта?')) {
                api.logout();
            }
        }

        window.logout = logout;

        async function init() {
            if (!(await requireAuth())) {
                return;
            }
            loadProfile();
        }

        init();
    </script>

    <script type="module">
        import { renderBottomNav } from './js/components.js';
        const navContainer = document.getElementById('bottom-nav');
        if (navContainer) {
            navContainer.innerHTML = renderBottomNav('profile');
        } else {
            document.body.insertAdjacentHTML('beforeend', renderBottomNav('profile'));
        }
    </script>
</body>
</html>
